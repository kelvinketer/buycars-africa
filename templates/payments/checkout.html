{% extends 'base.html' %}
{% load humanize %}
{% load currency_tags %}

{% block content %}
<div class="bg-light min-vh-100 py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <div class="text-center mb-4">
                    {% if booking %}
                        <h2 class="fw-bold">Complete Your Booking</h2>
                        <p class="text-muted">Secure your vehicle rental instantly.</p>
                    {% else %}
                        <h2 class="fw-bold">Complete Your Subscription</h2>
                        <p class="text-muted">Unlock features to grow your business.</p>
                    {% endif %}
                </div>

                <div class="row g-0 rounded-4 overflow-hidden shadow-lg bg-white">
                    
                    <div class="col-md-5 bg-light p-4 border-end">
                        <h5 class="fw-bold mb-4 text-uppercase text-muted small">Order Summary</h5>
                        
                        {% if booking %}
                            <div class="mb-3">
                                <h4 class="fw-bold mb-1 text-dark">{{ booking.car.year }} {{ booking.car.make }} {{ booking.car.model }}</h4>
                                <span class="badge bg-primary">For Hire</span>
                            </div>
                            
                            {% if booking.car.images.first %}
                                <img src="{{ booking.car.images.first.image.url }}" class="img-fluid rounded-3 mb-3 shadow-sm" style="height: 150px; width: 100%; object-fit: cover;">
                            {% endif %}

                            <ul class="list-unstyled mb-4 small text-muted">
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="far fa-calendar-alt me-2"></i>Pick-up</span>
                                    <strong>{{ booking.start_date|date:"M d, Y" }}</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="far fa-calendar-check me-2"></i>Return</span>
                                    <strong>{{ booking.end_date|date:"M d, Y" }}</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="fas fa-clock me-2"></i>Duration</span>
                                    <strong>{{ booking.days }} Days</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="fas fa-tag me-2"></i>Daily Rate</span>
                                    <strong>{% global_price booking.car.rent_price_per_day %}</strong>
                                </li>
                            </ul>
                            
                            <hr class="opacity-10 my-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Due:</span>
                                <h3 class="fw-bold text-success mb-0">{% global_price booking.total_price %}</h3>
                            </div>

                        {% else %}
                            <div class="mb-3">
                                <h4 class="fw-bold mb-0 text-dark">{{ plan_name }}</h4>
                                <span class="badge bg-dark">Dealer Plan</span>
                            </div>

                            <ul class="list-unstyled mb-4 small text-muted">
                                {% if plan_type == 'STARTER' %}
                                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> 5 Car Listings</li>
                                {% elif plan_type == 'LITE' %}
                                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> 15 Car Listings</li>
                                    <li class="mb-2"><i class="fas fa-star text-warning me-2"></i> Featured Listings</li>
                                {% elif plan_type == 'PRO' %}
                                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> 50 Car Listings</li>
                                    <li class="mb-2"><i class="fas fa-crown text-warning me-2"></i> Homepage Exposure</li>
                                {% endif %}
                            </ul>

                            <hr class="opacity-10 my-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Due:</span>
                                <h3 class="fw-bold text-danger mb-0">KES {{ amount|intcomma }}</h3>
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-7 p-0 bg-white">
                        
                        <div class="card-header bg-white border-bottom pt-4 pb-0 px-4">
                            <ul class="nav nav-tabs nav-fill border-0" id="paymentTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active fw-bold py-3 rounded-top-3" id="mpesa-tab" data-bs-toggle="tab" data-bs-target="#mpesa" type="button">
                                        <i class="fas fa-mobile-alt me-2"></i> M-Pesa (Local)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link fw-bold py-3 rounded-top-3 text-primary" id="card-tab" data-bs-toggle="tab" data-bs-target="#card" type="button">
                                        <i class="far fa-credit-card me-2"></i> Card (Global)
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <div class="card-body p-4">
                            <div class="tab-content" id="paymentTabsContent">
                                
                                <div class="tab-pane fade show active" id="mpesa" role="tabpanel">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-success text-white rounded p-2 me-3 fw-bold">M-PESA</div>
                                        <h5 class="fw-bold mb-0">Pay with M-Pesa</h5>
                                    </div>

                                    <div id="paymentStatus" class="alert alert-info border-0 d-flex align-items-center mb-4 p-3 d-none" role="alert"></div>

                                    <div id="defaultPrompt" class="alert alert-light border d-flex align-items-center mb-4 p-3">
                                        <i class="fas fa-mobile-alt fa-lg me-3 text-muted"></i>
                                        <div class="small text-muted">
                                            Enter your M-Pesa number below. You will receive a prompt on your phone to enter your PIN.
                                        </div>
                                    </div>

                                    <form id="paymentForm" onsubmit="return false;">
                                        {% csrf_token %}
                                        
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">M-PESA Phone Number</label>
                                            <div class="input-group input-group-lg border rounded overflow-hidden">
                                                <span class="input-group-text bg-light border-0 text-muted">
                                                    <i class="fas fa-phone-alt"></i>
                                                </span>
                                                <input type="tel" id="phoneInput" class="form-control border-0 bg-light fw-bold" 
                                                       placeholder="07XX..." value="{{ user.dealer_profile.phone_number }}" required>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button id="payBtn" class="btn btn-success btn-lg rounded-pill fw-bold py-3 shadow-sm">
                                                Pay Now
                                            </button>
                                            <a href="{% url 'home' %}" class="btn btn-link text-muted text-decoration-none btn-sm mt-2">
                                                Cancel Transaction
                                            </a>
                                        </div>
                                    </form>
                                    
                                    <div class="text-center mt-4 pt-3 border-top d-flex justify-content-center align-items-center text-muted small">
                                        <span class="me-2">Secured by Safaricom M-PESA</span>
                                        <i class="fas fa-shield-alt text-success"></i>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="card" role="tabpanel">
                                    <div class="alert alert-primary bg-opacity-10 border-primary text-primary small mb-4">
                                        <i class="fas fa-globe me-2"></i> Accepts Visa, Mastercard, and Amex from UK, US, Dubai & more.
                                    </div>
                                    
                                    <div class="text-center py-4">
                                        <div class="mb-4">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" height="30" class="mx-2 opacity-75">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" height="30" class="mx-2 opacity-75">
                                        </div>
                                        
                                        <p class="text-muted small mb-4">You will be redirected to our secure global payment gateway.</p>
                                        
                                        <button type="button" onclick="payWithFlutterwave()" class="btn btn-primary w-100 btn-lg fw-bold rounded-pill shadow-sm py-3">
                                            Pay securely with Card <i class="fas fa-lock ms-2"></i>
                                        </button>
                                        
                                        <div class="mt-3">
                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                <i class="fas fa-check-circle me-1 text-success"></i> 256-bit SSL Encrypted
                                            </small>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.flutterwave.com/v3.js"></script>
<script>
    // --- 1. M-PESA LOGIC ---
    document.getElementById('payBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        const phone = document.getElementById('phoneInput').value;
        const btn = this;
        const statusDiv = document.getElementById('paymentStatus');
        const defaultPrompt = document.getElementById('defaultPrompt');
        
        // Determine Payment Type
        const bookingId = "{{ booking.id|default:'' }}";
        const planType = "{{ plan_type|default:'' }}";

        if(phone.length < 10) {
            alert("Please enter a valid phone number");
            return;
        }

        // UI Updates
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Sending Request...';
        defaultPrompt.classList.add('d-none');
        statusDiv.classList.remove('d-none');
        statusDiv.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div><span>Sending STK Push to your phone...</span></div>';

        // Prepare Payload
        let payload = { phone_number: phone };
        if(bookingId) payload.booking_id = bookingId;
        if(planType) payload.plan_type = planType;

        // Send Request
        fetch("{% url 'initiate_payment' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                statusDiv.className = 'alert alert-warning border-0 mb-4 p-3';
                statusDiv.innerHTML = '<i class="fas fa-mobile-alt me-2"></i> <strong>Check your phone!</strong> Enter your M-Pesa PIN to complete payment.';
                
                // Start Polling
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    fetch("{% url 'check_payment_status' %}")
                    .then(r => r.json())
                    .then(statusData => {
                        if(statusData.status === 'SUCCESS') {
                            clearInterval(interval);
                            statusDiv.className = 'alert alert-success border-0 mb-4 p-3';
                            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i> Payment Received! Redirecting...';
                            
                            setTimeout(() => {
                                window.location.href = "{% url 'home' %}"; 
                            }, 2000);
                        } 
                        else if (statusData.status === 'FAILED') {
                            clearInterval(interval);
                            statusDiv.className = 'alert alert-danger border-0 mb-4 p-3';
                            statusDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i> Payment Failed or Cancelled.';
                            btn.disabled = false;
                            btn.innerHTML = 'Retry Payment';
                        }
                    });
                    
                    if(attempts > 30) {
                        clearInterval(interval);
                        statusDiv.className = 'alert alert-warning border-0 mb-4 p-3';
                        statusDiv.innerHTML = 'Session timed out. Did you enter your PIN?';
                        btn.disabled = false;
                        btn.innerHTML = 'Retry Payment';
                    }
                }, 2000);

            } else {
                statusDiv.className = 'alert alert-danger border-0 mb-4 p-3';
                statusDiv.innerHTML = data.message;
                btn.disabled = false;
                btn.innerHTML = 'Pay Now';
            }
        })
        .catch(err => {
            console.error(err);
            statusDiv.className = 'alert alert-danger border-0 mb-4 p-3';
            statusDiv.innerHTML = 'Connection error. Please try again.';
            btn.disabled = false;
            btn.innerHTML = 'Pay Now';
        });
    });

    // --- 2. FLUTTERWAVE LOGIC (UPDATED FOR BOOKING & SUBSCRIPTION) ---
    function payWithFlutterwave() {
        const timestamp = Date.now();
        let txRef = "";
        let desc = "";
        
        // Grab Values from Django Template
        const bookingId = "{{ booking.id|default:'' }}";
        const planType = "{{ plan_type|default:'' }}";
        const userId = "{{ request.user.id }}";
        const userEmail = "{{ request.user.email }}";
        const userPhone = "{{ request.user.profile.phone_number }}";
        const userName = "{{ request.user.get_full_name|default:request.user.username }}";
        
        // Fallback for amount (since we use different vars for plan/booking)
        let amount = 0;
        {% if booking %}
            amount = {{ booking.total_price }};
        {% else %}
            amount = {{ amount|default:0 }};
        {% endif %}

        // LOGIC: Build Reference ID based on Type
        if (bookingId) {
            // Case A: Car Rental
            txRef = "BKG-" + timestamp + "-" + bookingId;
            desc = "Car Booking: {{ booking.car.make }} {{ booking.car.model }}";
        } else if (planType) {
            // Case B: Dealer Subscription
            txRef = "SUB-" + timestamp + "-" + planType + "-" + userId;
            desc = "Dealer Subscription: " + planType;
        } else {
            alert("Error: Unknown payment type.");
            return;
        }

        FlutterwaveCheckout({
            public_key: "FLWPUBK_TEST-xxxxxxxxxx-X", // REPLACE WITH YOUR REAL KEY
            tx_ref: txRef,
            amount: amount,
            currency: "KES",
            payment_options: "card, mobilemoneyghana, ussd",
            redirect_url: "{% url 'verify_flutterwave' %}", 
            customer: {
                email: userEmail,
                phone_number: userPhone,
                name: userName,
            },
            customizations: {
                title: "BuyCars Africa",
                description: desc,
                logo: "https://buycars-africa.onrender.com/static/images/logo.png",
            },
        });
    }
</script>

<style>
    .nav-tabs .nav-link { border: none; color: #64748b; background: transparent; }
    .nav-tabs .nav-link.active { color: #000; background: #f8f9fa; border-bottom: 3px solid #dc3545; }
    .nav-tabs .nav-link:hover { color: #000; }
</style>
{% endblock %}