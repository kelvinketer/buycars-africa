{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<div class="bg-light min-vh-100 py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <div class="text-center mb-4">
                    {% if booking %}
                        <h2 class="fw-bold">Complete Your Booking</h2>
                        <p class="text-muted">Secure your vehicle rental instantly.</p>
                    {% else %}
                        <h2 class="fw-bold">Complete Your Subscription</h2>
                        <p class="text-muted">Unlock features to grow your business.</p>
                    {% endif %}
                </div>

                <div class="row g-0 rounded-4 overflow-hidden shadow-lg bg-white">
                    
                    <div class="col-md-5 bg-light p-4 border-end">
                        <h5 class="fw-bold mb-4 text-uppercase text-muted small">Order Summary</h5>
                        
                        {% if booking %}
                            <div class="mb-3">
                                <h4 class="fw-bold mb-1 text-dark">{{ booking.car.year }} {{ booking.car.make }} {{ booking.car.model }}</h4>
                                <span class="badge bg-primary">For Hire</span>
                            </div>
                            
                            <img src="{{ booking.car.images.first.image.url }}" class="img-fluid rounded-3 mb-3 shadow-sm" style="height: 150px; width: 100%; object-fit: cover;">

                            <ul class="list-unstyled mb-4 small text-muted">
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="far fa-calendar-alt me-2"></i>Pick-up</span>
                                    <strong>{{ booking.start_date|date:"M d, Y" }}</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="far fa-calendar-check me-2"></i>Return</span>
                                    <strong>{{ booking.end_date|date:"M d, Y" }}</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="fas fa-clock me-2"></i>Duration</span>
                                    <strong>{{ booking.days }} Days</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span><i class="fas fa-tag me-2"></i>Daily Rate</span>
                                    <strong>KES {{ booking.car.rent_price_per_day|intcomma }}</strong>
                                </li>
                            </ul>
                            
                            <hr class="opacity-10 my-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Due:</span>
                                <h3 class="fw-bold text-success mb-0">KES {{ booking.total_cost|intcomma }}</h3>
                            </div>

                        {% else %}
                            <div class="mb-3">
                                <h4 class="fw-bold mb-0 text-dark">{{ plan_name }}</h4>
                                <span class="badge bg-dark">Dealer Plan</span>
                            </div>

                            <ul class="list-unstyled mb-4 small text-muted">
                                {% if plan_type == 'STARTER' %}
                                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> 5 Car Listings</li>
                                {% elif plan_type == 'LITE' %}
                                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> 15 Car Listings</li>
                                    <li class="mb-2"><i class="fas fa-star text-warning me-2"></i> Featured Listings</li>
                                {% elif plan_type == 'PRO' %}
                                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> 50 Car Listings</li>
                                    <li class="mb-2"><i class="fas fa-crown text-warning me-2"></i> Homepage Exposure</li>
                                {% endif %}
                            </ul>

                            <hr class="opacity-10 my-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Due:</span>
                                <h3 class="fw-bold text-danger mb-0">KES {{ amount|intcomma }}</h3>
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-7 p-4 bg-white">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-success text-white rounded p-2 me-3 fw-bold">M-PESA</div>
                            <h5 class="fw-bold mb-0">Secure Payment</h5>
                        </div>

                        <div id="paymentStatus" class="alert alert-info border-0 d-flex align-items-center mb-4 p-3 d-none" role="alert"></div>

                        <div id="defaultPrompt" class="alert alert-light border d-flex align-items-center mb-4 p-3">
                            <i class="fas fa-mobile-alt fa-lg me-3 text-muted"></i>
                            <div class="small text-muted">
                                Enter your M-Pesa number below. You will receive a prompt on your phone to enter your PIN.
                            </div>
                        </div>

                        <form id="paymentForm" onsubmit="return false;">
                            {% csrf_token %}
                            
                            <div class="mb-4">
                                <label class="form-label fw-bold">M-PESA Phone Number</label>
                                <div class="input-group input-group-lg border rounded overflow-hidden">
                                    <span class="input-group-text bg-light border-0 text-muted">
                                        <i class="fas fa-phone-alt"></i>
                                    </span>
                                    <input type="tel" id="phoneInput" class="form-control border-0 bg-light fw-bold" 
                                           placeholder="07XX..." value="{{ user.dealer_profile.phone_number }}" required>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button id="payBtn" class="btn btn-success btn-lg rounded-pill fw-bold py-3 shadow-sm">
                                    Pay Now
                                </button>
                                <a href="{% url 'home' %}" class="btn btn-link text-muted text-decoration-none btn-sm mt-2">
                                    Cancel Transaction
                                </a>
                            </div>
                        </form>

                        <div class="text-center mt-4 pt-3 border-top d-flex justify-content-center align-items-center text-muted small">
                            <span class="me-2">Secured by Safaricom M-PESA</span>
                            <i class="fas fa-shield-alt text-success"></i>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('payBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        const phone = document.getElementById('phoneInput').value;
        const btn = this;
        const statusDiv = document.getElementById('paymentStatus');
        const defaultPrompt = document.getElementById('defaultPrompt');
        
        // 1. Determine Payment Type (Booking vs Plan)
        const bookingId = "{{ booking.id|default:'' }}";
        const planType = "{{ plan_type|default:'' }}";

        if(phone.length < 10) {
            alert("Please enter a valid phone number");
            return;
        }

        // 2. UI Updates
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Sending Request...';
        defaultPrompt.classList.add('d-none');
        statusDiv.classList.remove('d-none');
        statusDiv.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div><span>Sending STK Push to your phone...</span></div>';

        // 3. Prepare Payload
        let payload = { phone_number: phone };
        if(bookingId) payload.booking_id = bookingId;
        if(planType) payload.plan_type = planType;

        // 4. Send Request
        fetch("{% url 'initiate_payment' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                statusDiv.className = 'alert alert-warning border-0 mb-4 p-3';
                statusDiv.innerHTML = '<i class="fas fa-mobile-alt me-2"></i> <strong>Check your phone!</strong> Enter your M-Pesa PIN to complete payment.';
                
                // 5. Start Polling
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    fetch("{% url 'check_payment_status' %}")
                    .then(r => r.json())
                    .then(statusData => {
                        if(statusData.status === 'SUCCESS') {
                            clearInterval(interval);
                            statusDiv.className = 'alert alert-success border-0 mb-4 p-3';
                            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i> Payment Received! Redirecting...';
                            
                            setTimeout(() => {
                                window.location.href = "{% url 'home' %}"; 
                            }, 2000);
                        } 
                        else if (statusData.status === 'FAILED') {
                            clearInterval(interval);
                            statusDiv.className = 'alert alert-danger border-0 mb-4 p-3';
                            statusDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i> Payment Failed or Cancelled.';
                            btn.disabled = false;
                            btn.innerHTML = 'Retry Payment';
                        }
                    });
                    
                    // Timeout after 60 seconds
                    if(attempts > 30) {
                        clearInterval(interval);
                        statusDiv.className = 'alert alert-warning border-0 mb-4 p-3';
                        statusDiv.innerHTML = 'Session timed out. Did you enter your PIN?';
                        btn.disabled = false;
                        btn.innerHTML = 'Retry Payment';
                    }
                }, 2000); // Check every 2 seconds

            } else {
                statusDiv.className = 'alert alert-danger border-0 mb-4 p-3';
                statusDiv.innerHTML = data.message;
                btn.disabled = false;
                btn.innerHTML = 'Pay Now';
            }
        })
        .catch(err => {
            console.error(err);
            statusDiv.className = 'alert alert-danger border-0 mb-4 p-3';
            statusDiv.innerHTML = 'Connection error. Please try again.';
            btn.disabled = false;
            btn.innerHTML = 'Pay Now';
        });
    });
</script>
{% endblock %}