{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load currency_tags %}

{% block head_extra %}
<style>
    /* --- SOCIAL FEED STYLES --- */
    .feed-tabs-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 999;
        border-bottom: 1px solid #e2e8f0;
    }

    .nav-pills-feed .nav-link {
        color: #64748b;
        font-weight: 600;
        border-radius: 50px;
        padding: 10px 24px;
        transition: all 0.2s;
        font-size: 0.95rem;
    }
    .nav-pills-feed .nav-link.active {
        background-color: #0f172a; /* Dark Blue Brand */
        color: #fff;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }
    .nav-pills-feed .nav-link:hover:not(.active) {
        background-color: #f1f5f9;
        color: #334155;
    }

    /* Floating Create Button */
    .fab-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 25px rgba(220, 53, 69, 0.4);
        transition: transform 0.2s;
        z-index: 1000;
        position: fixed;
        bottom: 30px;
        right: 30px;
    }
    .fab-btn:hover {
        transform: translateY(-5px) rotate(90deg);
        color: white;
    }

    /* Hover Effects for Cards */
    .hover-lift { 
        transition: transform 0.3s ease, box-shadow 0.3s ease; 
    }
    .hover-lift:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important; 
    }

    /* Like Button Animation */
    .btn-like {
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
    }
    .btn-like:active { transform: scale(0.8); }
    .text-danger { color: #dc3545 !important; }
</style>
{% endblock %}

{% block content %}

<div class="bg-white border-bottom py-4 sticky-top" style="top: 0; z-index: 1020;">
    <div class="container">
        <form method="GET" action="{% url 'home' %}">
            <div class="row g-2">
                <div class="col-lg-5 col-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 rounded-start-pill ps-3">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" name="q" class="form-control bg-light border-start-0 rounded-end-pill py-2" 
                               placeholder="Search cars (e.g. Prado, Axela)" value="{{ request.GET.q|default:'' }}">
                    </div>
                </div>
                
                <div class="col-lg-3 d-none d-lg-block">
                    <select name="make" class="form-select bg-light rounded-pill border-0 py-2">
                        <option value="">All Makes</option>
                        {% for make in all_makes %}
                            <option value="{{ make }}" {% if request.GET.make == make %}selected{% endif %}>{{ make }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-lg-2 d-none d-lg-block">
                    <select name="region" class="form-select bg-light rounded-pill border-0 py-2">
                        <option value="">Location</option>
                        {% for code, name in regions %}
                            <option value="{{ code }}" {% if request.GET.region == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-lg-2 col-4">
                    <button type="submit" class="btn btn-dark w-100 rounded-pill fw-bold py-2">
                        Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="feed-tabs-container sticky-top" style="top: 85px;">
    <div class="container">
        <ul class="nav nav-pills nav-pills-feed nav-fill py-3" id="feedTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="fresh-tab" data-bs-toggle="tab" data-bs-target="#fresh" type="button">
                    <i class="fas fa-sparkles text-warning me-2"></i>Fresh Picks
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trending-tab" data-bs-toggle="tab" data-bs-target="#trending" type="button">
                    <i class="fas fa-fire text-danger me-2"></i>Trending
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="following-tab" data-bs-toggle="tab" data-bs-target="#following" type="button">
                    <i class="fas fa-user-friends text-primary me-2"></i>Following
                </button>
            </li>
        </ul>
    </div>
</div>

<div class="bg-light min-vh-100 py-4">
    <div class="container">
        
        <div class="tab-content" id="feedContent">
            
            <div class="tab-pane fade show active" id="fresh" role="tabpanel">
                <div class="row g-3">
                    {% for car in fresh_picks %}
                        {% include 'partials/feed_card.html' with car=car %}
                    {% empty %}
                        <div class="col-12 text-center py-5">
                            <img src="{% static 'images/empty_state.svg' %}" style="max-width: 200px; opacity: 0.5;">
                            <h5 class="mt-4 text-muted">No cars found matching your criteria.</h5>
                            {% if request.GET.q %}
                                <a href="{% url 'home' %}" class="btn btn-outline-dark rounded-pill mt-2">Clear Search</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="trending" role="tabpanel">
                <div class="row g-3">
                    {% for car in trending_cars %}
                        {% include 'partials/feed_card.html' with car=car %}
                    {% empty %}
                        <div class="col-12 text-center py-5">
                            <div class="text-muted">Like some cars to see what's trending!</div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="following" role="tabpanel">
                {% if user.is_authenticated %}
                    <div class="row g-3">
                        {% for car in following_cars %}
                            {% include 'partials/feed_card.html' with car=car %}
                        {% empty %}
                            <div class="col-12 text-center py-5">
                                <div class="bg-white p-5 rounded-4 shadow-sm mx-auto" style="max-width: 500px;">
                                    <i class="fas fa-user-plus fa-3x text-primary mb-3 opacity-50"></i>
                                    <h4>Your Feed is Empty</h4>
                                    <p class="text-muted mb-4">Follow verified dealers to see their latest inventory here first.</p>
                                    <a href="{% url 'dealership_network' %}" class="btn btn-primary rounded-pill px-4 fw-bold">Find Dealers to Follow</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="col-12 text-center py-5">
                        <div class="bg-white p-5 rounded-4 shadow-sm mx-auto" style="max-width: 500px;">
                            <i class="fas fa-lock fa-3x text-warning mb-3 opacity-50"></i>
                            <h4>Sign in to view</h4>
                            <p class="text-muted mb-4">Create a free account to follow your favorite dealers and build your personal feed.</p>
                            <a href="{% url 'login' %}" class="btn btn-dark rounded-pill px-5 fw-bold">Log In / Sign Up</a>
                        </div>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<a href="{% url 'sell_page' %}" class="fab-btn" title="Post a Car">
    <i class="fas fa-plus fa-lg"></i>
</a>

<script>
    function toggleLike(btn, carId) {
        // Optimistic UI Update
        const icon = btn.querySelector('i');
        const countSpan = btn.querySelector('.like-count');
        let currentCount = parseInt(countSpan.innerText || '0');

        if (icon.classList.contains('far')) {
            // User is Liking
            icon.classList.remove('far');
            icon.classList.add('fas', 'text-danger');
            // Animate
            btn.style.transform = "scale(1.2)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
        } else {
            // User is Unliking
            icon.classList.remove('fas', 'text-danger');
            icon.classList.add('far');
        }

        // Send Request to Backend
        fetch(`/social/like/${carId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // No need to update UI logic here, optimistic update handles it visually
            }
        })
        .catch(err => console.error('Like error:', err));
    }
</script>

{% endblock %}