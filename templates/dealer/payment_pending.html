{% extends 'base.html' %}

{% block content %}
<div class="bg-light min-vh-100 d-flex align-items-center justify-content-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                
                <div class="card border-0 shadow-lg rounded-4 p-5 text-center">
                    
                    <div class="mb-4">
                        <div class="spinner-grow text-success" role="status" style="width: 2.5rem; height: 2.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow text-success ms-2" role="status" style="width: 2.5rem; height: 2.5rem; animation-delay: 0.2s;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow text-success ms-2" role="status" style="width: 2.5rem; height: 2.5rem; animation-delay: 0.4s;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <h2 class="fw-bold text-dark mb-3">Check your Phone!</h2>
                    <p class="text-muted mb-4">
                        We sent a payment request to <br>
                        <strong class="text-dark fs-5">{{ phone }}</strong>
                    </p>
                    
                    <div class="alert alert-success bg-success-subtle text-success border-0 rounded-3 mb-4 py-3">
                        <i class="fas fa-mobile-alt me-2 fa-lg"></i> 
                        <strong>Enter your M-PESA PIN</strong>
                    </div>

                    <p class="small text-muted mb-4 fw-bold" id="status-message">
                        <i class="fas fa-sync fa-spin me-1"></i> Waiting for confirmation...
                    </p>
                    
                    <a href="{% url 'dealer_dashboard' %}" class="btn btn-link text-muted text-decoration-none btn-sm">
                        I didn't receive a prompt
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusMsg = document.getElementById('status-message');
        
        // Define the polling function
        const pollInterval = setInterval(() => {
            fetch("{% url 'check_payment_status' %}")
                .then(response => response.json())
                .then(data => {
                    console.log("Payment Status:", data.status);
                    
                    if (data.status === 'SUCCESS') {
                        // 1. STOP POLLING
                        clearInterval(pollInterval);

                        // 2. Update UI
                        statusMsg.innerHTML = '<span class="text-success fw-bold fs-5"><i class="fas fa-check-circle"></i> Payment Received!</span>';
                        
                        // 3. Redirect after short delay
                        setTimeout(() => {
                            window.location.href = "{% url 'dealer_dashboard' %}";
                        }, 1500);
                        
                    } else if (data.status === 'FAILED') {
                        // 1. STOP POLLING
                        clearInterval(pollInterval);

                        // 2. Show Error
                        statusMsg.innerHTML = '<span class="text-danger fw-bold"><i class="fas fa-times-circle"></i> Payment Failed. Please try again.</span>';
                    }
                })
                .catch(error => console.error('Error polling status:', error));
        }, 3000); // Check every 3 seconds
    });
</script>
{% endblock %}