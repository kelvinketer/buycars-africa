{% load humanize %}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Monthly Performance Report</title>
    <style type="text/css">
        @page {
            size: A4;
            margin: 0.5cm; /* Smaller margin for the full-width header effect */
            margin-bottom: 2cm;
        }
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 11px;
            color: #333333;
            line-height: 1.4;
            padding: 20px; /* Padding for content inside the page margins */
        }
        
        /* BRAND COLORS */
        /* Red: #E31E24 | Dark Blue: #0B132B */

        /* HEADER BANNER (The "Bold" Look) */
        .header-container {
            background-color: #0B132B;
            color: #ffffff;
            padding: 30px;
            border-bottom: 6px solid #E31E24; /* The Red Line */
            margin: -25px -25px 20px -25px; /* Negative margin to stretch full width */
        }
        
        .header-table { width: 100%; }
        
        .logo-text {
            font-size: 32px;
            font-weight: bold;
            color: #ffffff;
        }
        .logo-red { color: #E31E24; }
        
        .report-meta {
            text-align: right;
            color: #ffffff;
        }
        .report-title {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }
        .report-date {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        .dealer-name {
            font-size: 14px;
            margin-top: 5px;
            color: #ffc107; /* Gold accent for dealer name */
            font-weight: bold;
        }

        /* CORPORATE INFO STRIP */
        .info-strip {
            color: #666;
            font-size: 9px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 25px;
            text-align: right;
        }

        /* METRIC BOXES */
        .metrics-table { width: 100%; margin-bottom: 30px; }
        .metric-box {
            border: 1px solid #e0e0e0;
            background-color: #fcfcfc;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
        }
        .metric-value {
            font-size: 32px; /* Large, visible numbers */
            font-weight: bold;
            color: #0B132B;
            display: block;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 10px;
            text-transform: uppercase;
            color: #777;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .metric-red { color: #E31E24; }

        /* SECTIONS */
        .section-header {
            font-size: 14px;
            font-weight: bold;
            color: #0B132B;
            border-left: 5px solid #E31E24;
            padding-left: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
            background-color: #f4f4f4;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        /* DATA TABLE */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background-color: #0B132B;
            color: #ffffff;
            font-weight: bold;
            text-align: left;
            padding: 10px;
            font-size: 10px;
            text-transform: uppercase;
        }
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eeeeee;
            font-size: 11px;
            color: #333;
        }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        .row-highlight { color: #E31E24; font-weight: bold; }

        /* LEAD BREAKDOWN TABLE */
        .lead-summary-table { width: 100%; margin-bottom: 20px; border: 1px solid #eee; }
        .lead-summary-table td { padding: 15px; background: #fff; }
        
        /* NOTES */
        .notes-section {
            background-color: #fffbf2;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-top: 30px;
            border-radius: 4px;
        }
        .notes-header { font-weight: bold; color: #856404; margin-bottom: 5px; }
        .notes-list { margin: 0; padding-left: 15px; color: #555; font-size: 10px; }
        .notes-list li { margin-bottom: 3px; }

        /* FOOTER */
        .footer {
            position: fixed;
            bottom: -30px;
            left: 0px;
            right: 0px;
            text-align: center;
            font-size: 8px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <table class="header-table">
            <tr>
                <td width="50%" valign="middle">
                    <div class="logo-text">BuyCars<span class="logo-red">.Africa</span></div>
                </td>
                <td width="50%" valign="middle" align="right">
                    <div class="report-meta">
                        <div class="report-title">Monthly Performance Report</div>
                        <div class="report-date">{{ month_name }}</div>
                        <div class="dealer-name">{{ profile.business_name }}</div>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="info-strip">
        <strong>BuyCars Africa Ltd.</strong> | Ngong Road, Nairobi | Support: +254 727 025 050 | help@buycars.africa
    </div>

    <table class="metrics-table" cellspacing="10">
        <tr>
            <td width="33%">
                <div class="metric-box">
                    <span class="metric-value">{{ total_cars }}</span>
                    <span class="metric-label">Active Inventory</span>
                </div>
            </td>
            <td width="33%">
                <div class="metric-box">
                    <span class="metric-value">{{ total_views }}</span>
                    <span class="metric-label">Total Views</span>
                </div>
            </td>
            <td width="33%">
                <div class="metric-box">
                    <span class="metric-value metric-red">{{ total_leads }}</span>
                    <span class="metric-label">Total Leads</span>
                </div>
            </td>
        </tr>
    </table>

    <div class="section-header">Lead & Traffic Analysis</div>
    <div style="font-size: 11px; margin-bottom: 15px; color: #444;">
        <strong>Summary:</strong> Your inventory generated <strong>{{ total_views }} total views</strong> this month. 
        High-intent buyer actions (Leads) were tracked via WhatsApp clicks and Phone calls from the platform.
    </div>

    <table class="lead-summary-table">
        <tr>
            <td width="33%" align="center">
                <div style="font-size: 18px; font-weight: bold; color: #28a745;">{{ whatsapp_clicks }}</div>
                <div style="font-size: 9px; color: #666; text-transform: uppercase;">WhatsApp Chats</div>
            </td>
            <td width="33%" align="center" style="border-left: 1px solid #eee; border-right: 1px solid #eee;">
                <div style="font-size: 18px; font-weight: bold; color: #0B132B;">{{ calls }}</div>
                <div style="font-size: 9px; color: #666; text-transform: uppercase;">Phone Calls</div>
            </td>
            <td width="33%" align="center">
                <div style="font-size: 18px; font-weight: bold; color: #666;">
                    {% if total_views > 0 %}
                        {% widthratio total_leads total_views 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div style="font-size: 9px; color: #666; text-transform: uppercase;">Conversion Rate</div>
            </td>
        </tr>
    </table>

    <div class="section-header">Inventory Performance (Top 5)</div>
    <table class="data-table">
        <thead>
            <tr>
                <th width="45%">Vehicle</th>
                <th width="20%">Price (KES)</th>
                <th width="15%" align="center">Views</th>
                <th width="20%" align="right">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for car in top_cars %}
            <tr>
                <td>
                    <strong>{{ car.year }} {{ car.make }} {{ car.model }}</strong><br>
                    <span style="color: #888; font-size: 9px;">Listed: {{ car.created_at|date:"d M Y" }}</span>
                </td>
                <td>{{ car.price|intcomma }}</td>
                <td align="center"><strong>{{ car.num_views }}</strong></td>
                <td align="right">
                    {% if car.status == 'AVAILABLE' %}
                        <span style="color: #28a745; font-weight: bold;">Available</span>
                    {% elif car.status == 'RESERVED' %}
                        <span style="color: #ffc107; font-weight: bold;">Reserved</span>
                    {% else %}
                        <span style="color: #E31E24; font-weight: bold;">Sold</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" align="center" style="padding: 20px; color: #999;">
                    No available inventory data for this period.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="notes-section">
        <div class="notes-header">ðŸ’¡ Strategic Insights for {{ profile.business_name }}</div>
        <ul class="notes-list">
            <li><strong>Visibility:</strong> Vehicles with clear pricing and low mileage get 40% more clicks. Check your "Market Value" in the dashboard.</li>
            <li><strong>Engagement:</strong> 70% of buyers prefer WhatsApp. Ensure your phone number {{ profile.phone_number }} is active on WhatsApp.</li>
            <li><strong>Photos:</strong> Top-performing dealers upload at least 15 photos per car (Interior, Exterior, and Engine bay).</li>
        </ul>
    </div>

    <div class="footer">
        BuyCars.Africa Dealer System â€¢ Generated on {{ date|date:"F d, Y H:i" }} â€¢ Page <pdf:pagenumber>
    </div>

</body>
</html>