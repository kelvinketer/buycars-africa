{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load currency_tags %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        transition: transform 0.2s;
    }
    .dashboard-card:hover { transform: translateY(-3px); }
    
    .icon-box {
        width: 48px; height: 48px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
    
    .nav-pills .nav-link {
        color: #64748b;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px 20px;
    }
    .nav-pills .nav-link.active {
        background-color: #0f172a;
        color: #fff;
    }
    
    .table-hover tbody tr:hover { background-color: #f8fafc; }
    .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
</style>
{% endblock %}

{% block content %}
<div class="bg-light min-vh-100 py-4">
    <div class="container">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark mb-0">Dashboard</h2>
                <p class="text-muted mb-0">Welcome back, {{ user.dealer_profile.business_name|default:user.username }}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'profile_settings' %}" class="btn btn-white border shadow-sm fw-bold rounded-pill">
                    <i class="fas fa-cog me-2"></i> Settings
                </a>
                <a href="{% url 'add_car' %}" class="btn btn-success shadow-sm fw-bold rounded-pill">
                    <i class="fas fa-plus me-2"></i> Add Vehicle
                </a>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card h-100 p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small fw-bold text-uppercase mb-1">Total Stock</div>
                            <h2 class="fw-bold mb-0 text-dark">{{ total_cars }} <span class="text-muted fs-6 fw-normal">/ {{ limit }}</span></h2>
                        </div>
                        <div class="icon-box bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-car"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {% widthratio total_cars limit 100 %}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card dashboard-card h-100 p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small fw-bold text-uppercase mb-1">Total Leads</div>
                            <h2 class="fw-bold mb-0 text-dark">{{ total_leads }}</h2>
                        </div>
                        <div class="icon-box bg-success bg-opacity-10 text-success">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="mt-2 small text-success">
                        <i class="fas fa-arrow-up me-1"></i> Calls & WhatsApp
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card dashboard-card h-100 p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small fw-bold text-uppercase mb-1">Inventory Value</div>
                            <h4 class="fw-bold mb-0 text-dark">
                                <span class="fs-6 text-muted">KES</span> {{ total_value|intword }}
                            </h4>
                        </div>
                        <div class="icon-box bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card dashboard-card h-100 p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small fw-bold text-uppercase mb-1">Rental Requests</div>
                            <h2 class="fw-bold mb-0 text-dark">{{ pending_bookings }}</h2>
                        </div>
                        <div class="icon-box bg-info bg-opacity-10 text-info">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>
                    {% if pending_bookings > 0 %}
                        <div class="mt-2 small text-danger fw-bold">
                            Action Required
                        </div>
                    {% else %}
                        <div class="mt-2 small text-muted">
                            All caught up!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12">
                <h5 class="fw-bold text-dark mb-2">Grow Your Business</h5>
            </div>
            
            <div class="col-md-3">
                <div class="card dashboard-card border-0 h-100 bg-white p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Sales Agreement</h6>
                            <p class="text-muted small mb-0">Generate contract.</p>
                        </div>
                        <a href="#" class="btn btn-sm btn-outline-primary ms-auto rounded-pill px-3">Create</a>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card dashboard-card border-0 h-100 bg-white p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Market Prices</h6>
                            <p class="text-muted small mb-0">Check live values.</p>
                        </div>
                        <a href="#" class="btn btn-sm btn-outline-success ms-auto rounded-pill px-3">Check</a>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card dashboard-card border-0 h-100 bg-white p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning me-3">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Stock Loan</h6>
                            <p class="text-muted small mb-0">Get inventory capital.</p>
                        </div>
                        <a href="{% url 'partners_page' %}" class="btn btn-sm btn-outline-warning ms-auto rounded-pill px-3">Apply</a>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card dashboard-card border-0 h-100 bg-dark text-white p-3" style="background: linear-gradient(45deg, #0f172a, #1e293b);">
                    <div class="d-flex align-items-center h-100">
                        <div class="icon-box bg-white bg-opacity-10 text-white me-3">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1 text-white">Dealer Academy</h6>
                            <p class="text-white-50 small mb-0">Learn & Certify.</p>
                        </div>
                        <a href="{% url 'dealer_academy' %}" class="btn btn-sm btn-light text-dark ms-auto rounded-pill px-3 fw-bold">
                            Start
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card dashboard-card overflow-hidden">
                    <div class="card-header bg-white border-bottom p-3">
                        <ul class="nav nav-pills" id="dashboardTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">
                                    <i class="fas fa-car me-2"></i>Inventory
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="leads-tab" data-bs-toggle="tab" data-bs-target="#leads" type="button">
                                    <i class="fas fa-user-friends me-2"></i>Leads
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="rentals-tab" data-bs-toggle="tab" data-bs-target="#rentals" type="button">
                                    <i class="fas fa-key me-2"></i>Rentals
                                    {% if pending_bookings > 0 %}
                                        <span class="badge bg-danger rounded-pill ms-2">{{ pending_bookings }}</span>
                                    {% endif %}
                                </button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body p-0">
                        <div class="tab-content" id="dashboardTabsContent">
                            
                            <div class="tab-pane fade show active" id="inventory">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="ps-4 py-3">Vehicle</th>
                                                <th>Price</th>
                                                <th>Views</th>
                                                <th>Status</th>
                                                <th class="text-end pe-4">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for car in cars %}
                                            <tr>
                                                <td class="ps-4">
                                                    <div class="d-flex align-items-center">
                                                        {% if car.images.first %}
                                                            <img src="{{ car.images.first.image.url }}" class="rounded-3 me-3 border" width="48" height="36" style="object-fit: cover;">
                                                        {% else %}
                                                            <div class="rounded-3 me-3 bg-light border d-flex align-items-center justify-content-center" style="width:48px; height:36px;">
                                                                <i class="fas fa-car text-muted"></i>
                                                            </div>
                                                        {% endif %}
                                                        <div>
                                                            <div class="fw-bold text-dark">{{ car.year }} {{ car.make }}</div>
                                                            <div class="small text-muted">{{ car.model }}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if car.listing_type == 'RENT' %}
                                                        <span class="text-primary fw-bold">{{ car.listing_currency }} {{ car.rent_price_per_day|intcomma }}/day</span>
                                                    {% else %}
                                                        <span class="text-success fw-bold">{{ car.listing_currency }} {{ car.price|intcomma }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark border">{{ car.views.count }}</span>
                                                </td>
                                                <td>
                                                    {% if car.status == 'AVAILABLE' %}
                                                        <span class="badge bg-success-subtle text-success border border-success rounded-pill">Active</span>
                                                    {% elif car.status == 'SOLD' %}
                                                        <span class="badge bg-secondary-subtle text-secondary border rounded-pill">Sold</span>
                                                    {% else %}
                                                        <span class="badge bg-warning-subtle text-warning border border-warning rounded-pill">{{ car.status }}</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end pe-4">
                                                    <div class="dropdown">
                                                        <button class="btn btn-light btn-sm rounded-circle shadow-sm border" type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-3">
                                                            <li><a class="dropdown-item" href="{% url 'edit_car' car.id %}"><i class="fas fa-edit me-2 text-muted"></i> Edit</a></li>
                                                            <li><a class="dropdown-item" href="{% url 'car_detail' car.id %}" target="_blank"><i class="fas fa-eye me-2 text-muted"></i> View Live</a></li>
                                                            {% if car.status == 'AVAILABLE' %}
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li><a class="dropdown-item text-success fw-bold" href="{% url 'mark_as_sold' car.id %}"><i class="fas fa-check me-2"></i> Mark Sold</a></li>
                                                            {% endif %}
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li><a class="dropdown-item text-danger" href="{% url 'delete_car' car.id %}"><i class="fas fa-trash me-2"></i> Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-5 text-muted">
                                                    <i class="fas fa-car fa-3x mb-3 opacity-25"></i>
                                                    <p>No vehicles added yet.</p>
                                                    <a href="{% url 'add_car' %}" class="btn btn-sm btn-primary rounded-pill">Add First Car</a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="leads">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="ps-4 py-3">Vehicle</th>
                                                <th>Action</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for lead in recent_leads %}
                                            <tr>
                                                <td class="ps-4">
                                                    <a href="{% url 'car_detail' lead.car.id %}" class="text-dark text-decoration-none fw-bold">
                                                        {{ lead.car.year }} {{ lead.car.make }} {{ lead.car.model }}
                                                    </a>
                                                </td>
                                                <td>
                                                    {% if lead.action_type == 'WHATSAPP' %}
                                                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3">
                                                            <i class="fab fa-whatsapp me-1"></i> WhatsApp
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-dark bg-opacity-10 text-dark border border-dark border-opacity-25 rounded-pill px-3">
                                                            <i class="fas fa-phone-alt me-1"></i> Call Reveal
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-muted small">{{ lead.timestamp|naturaltime }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="3" class="text-center py-5 text-muted">No leads yet. Share your profile!</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="rentals">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="ps-4 py-3">Vehicle</th>
                                                <th>Renter</th>
                                                <th>Dates</th>
                                                <th>Total</th>
                                                <th class="text-end pe-4">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for booking in rental_bookings %}
                                            <tr>
                                                <td class="ps-4 fw-bold text-dark">{{ booking.car.make }} {{ booking.car.model }}</td>
                                                <td>
                                                    <div>{{ booking.renter.username }}</div>
                                                    <small class="text-muted">{{ booking.renter.email }}</small>
                                                </td>
                                                <td>
                                                    <div class="small fw-bold">{{ booking.start_date|date:"d M" }} - {{ booking.end_date|date:"d M" }}</div>
                                                    <small class="text-muted">{{ booking.total_days }} days</small>
                                                </td>
                                                <td class="fw-bold text-primary">
                                                    KES {{ booking.total_cost|intcomma }}
                                                </td>
                                                <td class="text-end pe-4">
                                                    {% if booking.status == 'PENDING' %}
                                                        <span class="badge bg-warning text-dark">Pending</span>
                                                    {% elif booking.status == 'PAID' %}
                                                        <span class="badge bg-success">Paid & Active</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ booking.status }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-5 text-muted">No rental requests found.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                
                <div class="card dashboard-card mb-4 p-4">
                    <h5 class="fw-bold mb-3">Lead Performance</h5>
                    <canvas id="leadsChart" height="200"></canvas>
                </div>

                {% if hot_car %}
                <div class="card dashboard-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Most Viewed</h5>
                        <i class="fas fa-fire text-danger"></i>
                    </div>
                    
                    {% if hot_car.images.first %}
                        <img src="{{ hot_car.images.first.image.url }}" class="rounded-3 w-100 mb-3 border" style="height: 150px; object-fit: cover;">
                    {% endif %}
                    
                    <h6 class="fw-bold text-dark">{{ hot_car.year }} {{ hot_car.make }} {{ hot_car.model }}</h6>
                    <div class="d-flex justify-content-between text-muted small mt-2">
                        <span><i class="fas fa-eye me-1"></i> {{ hot_car.view_count }} views</span>
                        <span><i class="far fa-clock me-1"></i> {{ hot_car.created_at|timesince }} ago</span>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Chart
    const ctx = document.getElementById('leadsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Leads',
                data: {{ chart_values|safe }},
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { display: false } },
                x: { grid: { display: false }, ticks: { display: false } } // Hide X labels for cleaner look
            }
        }
    });
</script>
{% endblock %}