{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://cdn.jsdelivr.net/npm/countup.js@2.0.7/dist/countUp.umd.js"></script>
{% endblock %}

{% block content %}
<style>
    /* --- THEME: COMMAND CENTER --- */
    :root {
        --neon-green: #00ff9d;
        --deep-space: #0b1120; 
        --panel-bg: rgba(15, 23, 42, 0.6);
    }

    body { background-color: var(--deep-space); }

    .bg-grid-pattern {
        background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
    }

    .glass-panel {
        background: var(--panel-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
        font-family: 'Inter', sans-serif; /* Monospace-ish for data */
        letter-spacing: -1px;
        background: -webkit-linear-gradient(45deg, #fff, #94a3b8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .live-dot {
        width: 8px; height: 8px;
        background-color: var(--neon-green);
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 10px var(--neon-green);
        animation: blink 2s infinite;
    }

    @keyframes blink { 50% { opacity: 0.4; } }

    #impact-map {
        height: 500px;
        width: 100%;
        border-radius: 12px;
        z-index: 1;
    }
</style>

<div class="position-relative overflow-hidden bg-grid-pattern pb-5">
    
    <div class="container pt-4 pb-5">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-1 rounded-pill d-flex align-items-center small fw-bold">
                    <span class="live-dot me-2"></span> LIVE OPERATIONS
                </div>
                <h5 class="text-white mb-0 fw-normal border-start border-secondary ps-3 ms-1 border-opacity-25">Project: Green Lung</h5>
            </div>
            <div class="text-white-50 small font-monospace d-none d-md-block">
                SYS.TIME: <span id="clock">--:--:--</span> UTC
            </div>
        </div>
    </div>

    <div class="container position-relative z-2">
        <div class="row g-4">
            
            <div class="col-lg-3 col-md-6">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-white-50 text-uppercase fw-bold ls-1">Trees Planted</small>
                        <i class="fas fa-tree text-success"></i>
                    </div>
                    <div class="display-4 fw-bold stat-value" id="tree-counter">{{ trees_planted|default:"0" }}</div>
                    <div class="mt-3 text-success small">
                        <i class="fas fa-arrow-up me-1"></i> <strong>25</strong> added this hour
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-white-50 text-uppercase fw-bold ls-1">Carbon Offset</small>
                        <i class="fas fa-cloud text-info"></i>
                    </div>
                    <div class="display-4 fw-bold stat-value">{{ co2_offset|floatformat:1 }} <span class="fs-4 text-muted">t</span></div>
                    <div class="mt-3 text-white-50 small">
                        ~20kg CO‚ÇÇ / tree / year
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-white-50 text-uppercase fw-bold ls-1">Active Sites</small>
                        <i class="fas fa-map-marker-alt text-warning"></i>
                    </div>
                    <div class="display-4 fw-bold stat-value">4</div>
                    <div class="mt-3 text-warning small">
                        <i class="fas fa-satellite-dish me-1"></i> Monitoring Active
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="glass-panel p-4 h-100 position-relative overflow-hidden">
                    <div class="position-relative z-2">
                        <small class="text-white-50 text-uppercase fw-bold ls-1">Community Fund</small>
                        <h4 class="text-white mt-2 mb-3">Accelerate the Mission</h4>
                        <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                            <input type="hidden" name="cmd" value="_donations" />
                            <input type="hidden" name="business" value="kipchirchir101@gmail.com" /> <input type="hidden" name="currency_code" value="USD" />
                            <input type="hidden" name="item_name" value="1 Million Trees Fund" />
                            <button class="btn btn-success w-100 fw-bold rounded-pill shadow-lg">
                                Donate $10 <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </form>
                    </div>
                    <div class="position-absolute bottom-0 end-0 translate-middle-y bg-success rounded-circle opacity-10" style="width: 100px; height: 100px; filter: blur(40px);"></div>
                </div>
            </div>

        </div>

        <div class="row mt-4">
            <div class="col-lg-9">
                <div class="glass-panel p-1">
                    <div id="impact-map"></div>
                </div>
            </div>
            
            <div class="col-lg-3">
                <div class="glass-panel p-4 h-100 d-flex flex-column">
                    <h6 class="text-white fw-bold mb-4 border-bottom border-secondary border-opacity-25 pb-3">
                        <i class="fas fa-history me-2 text-primary"></i>Recent Activity
                    </h6>
                    
                    <div class="flex-grow-1 overflow-hidden">
                        <ul class="list-unstyled text-white-50 small space-y-3" id="feed-list">
                            <li class="mb-3 d-flex gap-2">
                                <span class="text-success">‚óè</span> 
                                <div>
                                    <strong class="text-white">New Sale (Nairobi)</strong><br>
                                    Funded 25 Seedlings
                                </div>
                            </li>
                            <li class="mb-3 d-flex gap-2">
                                <span class="text-success">‚óè</span> 
                                <div>
                                    <strong class="text-white">Partner Joined</strong><br>
                                    AutoHub Mombasa
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="mt-auto pt-3 border-top border-secondary border-opacity-25">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-white-50 small">Target: Q1 2026</span>
                            <span class="text-white fw-bold small">15%</span>
                        </div>
                        <div class="progress mt-2" style="height: 4px; background: rgba(255,255,255,0.1);">
                            <div class="progress-bar bg-success" style="width: 15%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<section class="py-5 bg-white">
    <div class="container py-5">
        <div class="row align-items-center g-5">
            <div class="col-lg-5">
                <h6 class="text-success fw-bold text-uppercase ls-2 mb-3">Our Methodology</h6>
                <h2 class="display-5 fw-bold text-dark mb-4">Not Just Planting.<br>Engineering.</h2>
                <p class="lead text-muted mb-4">
                    Most tree-planting projects fail because they plant and walk away. We use a 3-step verification process to ensure survival.
                </p>
                
                <div class="d-flex gap-4 mb-4">
                    <div class="text-center">
                        <div class="bg-light p-3 rounded-circle mb-2 d-inline-block">
                            <i class="fas fa-satellite fa-2x text-primary"></i>
                        </div>
                        <p class="small fw-bold">Sat-Nav<br>Monitoring</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-light p-3 rounded-circle mb-2 d-inline-block">
                            <i class="fas fa-hand-holding-water fa-2x text-info"></i>
                        </div>
                        <p class="small fw-bold">Community<br>Stewards</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-light p-3 rounded-circle mb-2 d-inline-block">
                            <i class="fas fa-chart-pie fa-2x text-warning"></i>
                        </div>
                        <p class="small fw-bold">Survival<br>Audits</p>
                    </div>
                </div>
                
                <a href="{% url 'transparency_hub' %}" class="btn btn-outline-dark rounded-pill px-4 fw-bold">
                    Audit Our Ledger
                </a>
            </div>
            
            <div class="col-lg-7">
                <div class="row g-3">
                    <div class="col-6">
                        <img src="https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=1000&auto=format&fit=crop" class="img-fluid rounded-4 shadow-sm mb-3" alt="Sapling">
                        <img src="https://images.unsplash.com/photo-1448375240586-dfd8f37933ff?q=80&w=1000&auto=format&fit=crop" class="img-fluid rounded-4 shadow-sm" alt="Forest">
                    </div>
                    <div class="col-6 pt-5">
                        <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb7d5fa5?q=80&w=1000&auto=format&fit=crop" class="img-fluid rounded-4 shadow-sm mb-3" alt="Planting">
                        <div class="p-4 bg-light rounded-4">
                            <h3 class="fw-bold text-success mb-0">94%</h3>
                            <small class="text-muted text-uppercase fw-bold">Survival Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. CLOCK
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toISOString().slice(11, 19);
        }, 1000);

        // 2. COUNTER ANIMATION
        const countUp = new countUp.CountUp('tree-counter', {{ trees_planted|default:0 }});
        if (!countUp.error) countUp.start();

        // 3. MAP INIT
        var map = L.map('impact-map', {
            zoomControl: false,
            scrollWheelZoom: false,
            dragging: !L.Browser.mobile 
        }).setView([0.5, 20.0], 4); // Pan-Africa View

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'CARTO',
            subdomains: 'abcd',
            maxZoom: 10
        }).addTo(map);

        // 4. LOCATIONS
        var sites = [
            { lat: -1.2921, lng: 36.8219, title: "üá∞üá™ Nairobi HQ", type: "Active" },
            { lat: -0.3031, lng: 36.0800, title: "üá∞üá™ Rift Valley A", type: "Active" },
            { lat: 9.1450, lng: 40.4897, title: "üá™üáπ Ethiopia Pilot", type: "Pending" }
        ];

        sites.forEach(site => {
            let color = site.type === "Active" ? "#22c55e" : "#3b82f6";
            let pulseHtml = `<div style="width:12px;height:12px;background:${color};border-radius:50%;box-shadow:0 0 0 4px ${color}40;animation:pulse 2s infinite;"></div>`;
            
            L.marker([site.lat, site.lng], {
                icon: L.divIcon({ className: 'custom-pin', html: pulseHtml, iconSize: [20,20] })
            }).addTo(map).bindPopup(`<b style="color:#333">${site.title}</b><br>${site.type}`);
        });

        // 5. LIVE FEED SIMULATION (Social Proof)
        const feed = document.getElementById('feed-list');
        const actions = [
            "New Partner: Apex Motors", "25 Trees Planted (Sale #4920)", "Donation Received: $50", 
            "Site Update: Rain reported in Narok", "New Broker Joined: Sarah K."
        ];
        
        let i = 0;
        setInterval(() => {
            const item = document.createElement('li');
            item.className = "mb-3 d-flex gap-2 animate-fade-in";
            item.innerHTML = `<span class="text-success">‚óè</span> <div class="text-white-50">${actions[i % actions.length]}</div>`;
            feed.prepend(item);
            if(feed.children.length > 5) feed.lastElementChild.remove();
            i++;
        }, 5000);
    });
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
</style>

{% endblock %}