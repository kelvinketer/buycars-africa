{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="card border-0 shadow-sm rounded-4 mb-3">
                <div class="card-body d-flex align-items-center justify-content-between p-3">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'inbox' %}" class="btn btn-light rounded-circle me-3"><i class="fas fa-arrow-left"></i></a>
                        <div>
                            <h6 class="mb-0 fw-bold">{{ conversation.car.year }} {{ conversation.car.make }} {{ conversation.car.model }}</h6>
                            <small class="text-muted">
                                {{ conversation.car.price|intcomma }} {{ conversation.car.listing_currency }} â€¢ 
                                <span class="text-success fw-bold">{{ conversation.car.status }}</span>
                            </small>
                        </div>
                    </div>
                    <a href="{% url 'car_detail' conversation.car.id %}" class="btn btn-outline-dark btn-sm rounded-pill px-3">View Car</a>
                </div>
            </div>

            <div class="card border-0 shadow rounded-4 overflow-hidden" style="height: 600px;">
                <div class="card-body bg-light overflow-auto d-flex flex-column p-4" id="chat-box">
                    {% for message in conversation.messages.all %}
                        <div class="d-flex mb-3 {% if message.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="{% if message.sender == request.user %}bg-dark text-white{% else %}bg-white text-dark shadow-sm{% endif %} p-3 rounded-4" style="max-width: 75%; min-width: 120px;">
                                <p class="mb-1 small">{{ message.content }}</p>
                                <div class="text-end opacity-50" style="font-size: 0.7rem;">
                                    {{ message.timestamp|time:"H:i" }}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center text-muted mt-5">
                            <p>This is the start of your conversation.</p>
                        </div>
                    {% endfor %}
                </div>

                <div class="card-footer bg-white border-top p-3">
                    <form method="POST" class="d-flex gap-2">
                        {% csrf_token %}
                        <div class="flex-grow-1">
                            {{ form.content }} 
                        </div>
                        <button type="submit" class="btn btn-danger rounded-circle shadow-sm" style="width: 50px; height: 50px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Auto-scroll to bottom of chat
    var chatBox = document.getElementById("chat-box");
    chatBox.scrollTop = chatBox.scrollHeight;
</script>

<style>
    /* Clean up the form textarea to look like a chat input */
    textarea.form-control {
        resize: none;
        border-radius: 25px;
        background-color: #f8f9fa;
        border: 1px solid #eee;
        padding: 12px 20px;
        font-size: 0.95rem;
    }
    textarea.form-control:focus {
        background-color: #fff;
        box-shadow: none;
        border-color: #ddd;
    }
</style>
{% endblock %}